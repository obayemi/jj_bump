#!/bin/bash

set -e

if ! command -v jj &> /dev/null; then
    echo "Error: jj command not found. Please install Jujutsu." >&2
    exit 1
fi

bookmarks=$(jj log -r '::@-' --no-graph -T 'bookmarks' | tr ' ' '\n' | grep -v '^$' | grep -v '@' || true)

if [ -z "$bookmarks" ]; then
    echo "Error: No local bookmarks found on the previous commit." >&2
    exit 1
fi

latest_bookmark=$(echo "$bookmarks" | head -n 1)

last_non_empty=$(jj log -r "::@ & ~empty()" --no-graph -T 'commit_id ++ "\n"' | head -n 1)

if [ -z "$last_non_empty" ]; then
    echo "Error: No non-empty revision found in current commit lineage." >&2
    exit 1
fi

echo "Moving bookmark '$latest_bookmark' to commit $last_non_empty"
jj bookmark set "$latest_bookmark" -r "$last_non_empty"
